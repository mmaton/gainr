name: Helmfile CI

on:
  workflow_run:
    workflows: ["Build and publish images"]
    branches: ["*"]
    types:
      - completed

jobs:
  helmfile:
    name: Helmfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@main

      - name: Apply Helmfile
        uses: hiberbee/github-action-helm@1.3.0
        env: # Or as an environment variable
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        with:
          helmfile: helmfile apply --selector name=crypto-ingress --set image.tag="${{ github.sha }}" --set influx.host="${{ secrets.influx_host }}" --set influx.token="${{ secrets.influx_token }}"
          helmfile-config: helm/helmfile.yaml
          namespace: ${{ GITHUB_REF_NAME }}
